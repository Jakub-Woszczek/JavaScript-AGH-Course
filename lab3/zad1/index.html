<!-- @author Stanisław Polak <polak@agh.edu.pl> -->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Animation</title>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body>
<div id="root"></div>
<hr>
<form onsubmit="event.preventDefault();">
    <h2>requestAnimationFrame()</h2>
    <label for="counter">Counter→</label>
    <output id="counter" style="font-size: 4vh; color: red;">0</output>
    <br>
    <button id="start" onclick="startAnimation()">Start</button>
    <button id="stop" disabled onclick="stopAnimation()">Stop</button>
    <!-- ************************************************************** -->
    <hr>
    <h2>Time-consuming calculations in the main thread</h2>
    <label for="result_main">Result:</label>
    <output id="result_main">0</output>
    <br>
    <label for="iterations_main">Number of iterations:</label>
    <input id="iterations_main" type="text" value="50" onfocus="document.forms[0].result_main.value ='0'">
    <button
            onclick="document.forms[0].result_main.value = calculatePrimes(document.forms[0].iterations_main.value || 50)">Run
        calculations</button>
    <!-- ************************************************************** -->
    <h2>Time-consuming calculations in a separate thread</h2>
    <label for="result_worker">Result:</label>
    <output id="result_worker">0</output>
    <br>
    <label for="iterations_worker">Number of iterations:</label>
    <input id="iterations_worker" type="text" value="50" onfocus="document.forms[0].result_worker.value ='0'">
    <button
            onclick="calculatePrimesInBackground(document.forms[0].iterations_worker.value || 50)">Run
        calculations</button>
</form>
<script>
    let animation;
    let counter = 0;

    // Source: https://udn.realityripple.com/docs/Tools/Performance/Scenarios/Intensive_JavaScript
    function calculatePrimes(iterations) {
        let primes = [];
        for (let i = 0; i < iterations; i++) {
            let candidate = i * (1000000000 * Math.random());
            let isPrime = true;
            for (var c = 2; c <= Math.sqrt(candidate); ++c) {
                if (candidate % c === 0) {
                    // not prime
                    isPrime = false;
                    break;
                }
            }
            if (isPrime) {
                primes.push(candidate);
            }
        }
        return primes;
    }

    function calculatePrimesInBackground(iterations) {
        const worker = new Worker('worker.js');

        worker.postMessage(iterations);
        worker.onmessage = function(e) {
            document.forms[0].result_worker.value = e.data;
        };

        worker.onerror = function(e) {
            console.error('Błąd w workerze:', e.message);
        };
    }

    function startAnimation() {
        document.forms[0].start.disabled = true;
        document.forms[0].stop.disabled = false;
        animation = window.requestAnimationFrame(step);
    }

    function step() {
        document.forms[0].counter.value = counter++;
        animation = window.requestAnimationFrame(step);
    }

    function stopAnimation() {
        document.forms[0].start.disabled = false;
        document.forms[0].stop.disabled = true;
        window.cancelAnimationFrame(animation)
    }
</script>

<!-- Komponent Counter -->
<script type="text/babel" data-type="module">
    import React, { useState, useRef, useEffect } from "https://esm.sh/react?dev";
    import ReactDOMClient from "https://esm.sh/react-dom/client?dev";

    function Counter({ initial, delay }) {
        const [count, setCount] = useState(Number(initial));
        const intervalRef = useRef(null);

        const start = () => {
            if (intervalRef.current !== null) return;
            intervalRef.current = setInterval(() => {
                setCount(prev => prev + 1);
            }, Number(delay));
        };

        const stop = () => {
            clearInterval(intervalRef.current);
            intervalRef.current = null;
        };

        useEffect(() => {
            return () => clearInterval(intervalRef.current); // czyść przy odmontowaniu
        }, []);

        return (
            <div style={{ backgroundColor: "#d7e4d6", padding: "1rem", margin: "1rem", borderRadius: "8px" }}>
                <span>Counter→ </span>
                <span style={{ color: "red", fontWeight: "bold" }}>{count}</span>
                <br />
                <button onClick={start}>Start</button>
                <button onClick={stop}>Stop</button>
            </div>
        );
    }

    const container = document.getElementById("root");
    const root = ReactDOMClient.createRoot(container);
    root.render(
        <>
            <Counter initial="10" delay="100" />
            <Counter initial="15" delay="50" />
        </>
    );
</script>
</body>

</html>